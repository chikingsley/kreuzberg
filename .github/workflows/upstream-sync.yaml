name: Sync Upstream Main

on:
  schedule:
    - cron: "30 7 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    name: Open Upstream Sync PR
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Sync from fork parent and open PR
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          PARENT_REPO=$(gh api "repos/${GITHUB_REPOSITORY}" --jq '.parent.full_name // empty')
          if [[ -z "${PARENT_REPO}" ]]; then
            echo "Repository is not a fork. Skipping upstream sync."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git remote get-url upstream >/dev/null 2>&1; then
            git remote set-url upstream "https://github.com/${PARENT_REPO}.git"
          else
            git remote add upstream "https://github.com/${PARENT_REPO}.git"
          fi

          git fetch upstream main

          BEHIND=$(git rev-list --count origin/main..upstream/main)
          AHEAD=$(git rev-list --count upstream/main..origin/main)

          {
            echo "## Upstream Sync Check"
            echo
            echo "- Parent repo: \`${PARENT_REPO}\`"
            echo "- Behind upstream/main: \`${BEHIND}\` commit(s)"
            echo "- Ahead of upstream/main: \`${AHEAD}\` commit(s)"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "${BEHIND}" -eq 0 ]]; then
            echo "Already up to date with upstream/main."
            exit 0
          fi

          SYNC_BRANCH="codex/upstream-sync"
          git checkout -B "${SYNC_BRANCH}" origin/main
          git merge --no-edit upstream/main
          git push origin "${SYNC_BRANCH}" --force-with-lease

          EXISTING_PR_URL=$(gh pr list \
            --head "${SYNC_BRANCH}" \
            --base main \
            --state open \
            --json url \
            --jq '.[0].url // empty')

          if [[ -n "${EXISTING_PR_URL}" ]]; then
            echo "Updated existing PR: ${EXISTING_PR_URL}"
            echo "- Sync PR: ${EXISTING_PR_URL}" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          PR_TITLE="Sync upstream main ($(date -u +%Y-%m-%d))"
          PR_BODY=$(printf 'Automated sync from `%s:main` into this fork `main`.\n\n- Triggered by: `%s`\n- Run: https://github.com/%s/actions/runs/%s\n- Behind commits at start: `%s`' \
            "${PARENT_REPO}" "${GITHUB_WORKFLOW}" "${GITHUB_REPOSITORY}" "${GITHUB_RUN_ID}" "${BEHIND}")

          NEW_PR_URL=$(gh pr create \
            --base main \
            --head "${SYNC_BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}")

          echo "Created PR: ${NEW_PR_URL}"
          echo "- Sync PR: ${NEW_PR_URL}" >> "$GITHUB_STEP_SUMMARY"
